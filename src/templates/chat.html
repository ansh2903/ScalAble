<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="theme">
    <div class="dashboard">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        <path d="M12 22V12" stroke="currentColor" stroke-width="2"/>
                        <path d="M22 7L12 12L2 7" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </div>
                
            <nav class="sidebar-nav" role="navigation" aria-label="Main navigation">
                <ul class="nav-list" role="menu">
                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item active" aria-current="page">
                            <div class="nav-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="3" width="7" height="7" stroke="currentColor" stroke-width="2" rx="1"/>
                                    <rect x="14" y="3" width="7" height="7" stroke="currentColor" stroke-width="2" rx="1"/>
                                    <rect x="14" y="14" width="7" height="7" stroke="currentColor" stroke-width="2" rx="1"/>
                                    <rect x="3" y="14" width="7" height="7" stroke="currentColor" stroke-width="2" rx="1"/>
                                </svg>
                            </div>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/Chat icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="/connections" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/Database icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item">
                            <div class="nav-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12.89 1.45L8 5.6C7.11 6.27 6.6 7.33 6.6 8.45V14.45C6.6 15.57 7.11 16.63 8 17.3L12.89 21.45C11.3 22.5 9.1 22.5 7.51 21.45L2.62 17.3C1.73 16.63 1.22 15.57 1.22 14.45V8.45C1.22 7.33 1.73 6.27 2.62 5.6L7.51 1.45C9.1 0.4 11.3 0.4 12.89 1.45Z" fill="currentColor"/>
                                    <path d="M22.78 9.55V15.55C22.78 16.67 22.27 17.73 21.38 18.4L16.49 22.55C14.9 23.6 12.7 23.6 11.11 22.55L16 18.4C16.89 17.73 17.4 16.67 17.4 15.55V9.55C17.4 8.43 16.89 7.37 16 6.7L11.11 2.55C12.7 1.5 14.9 1.5 16.49 2.55L21.38 6.7C22.27 7.37 22.78 8.43 22.78 9.55Z" fill="currentColor"/>
                                </svg>
                            </div>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="https://github.com/ansh2903/ScalAble" target="_blank" rel="noopener noreferrer" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/github icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="https://www.linkedin.com/in/asharma2903/" target="_blank" rel="noopener noreferrer" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/linkedin icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <nav class ="sidebar-footer" role="navigation" aria-label="Footer navigation">
                <ul class="nav-list" role="menu">
                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/Settings icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>

                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/Help icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>

                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item">
                            <div class="nav-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="currentColor"/>
                                    <path d="M11,15H13V17H11V15Z" fill="currentColor"/>
                                    <path d="M11,9H13V13H11V9Z" fill="currentColor"/>
                                </svg>
                            </div>
                        </a>
                    </li>
                </ul>
                <span class="version">v0.6</span>
                <span class="copyright">&copy; 2023 ScalAble</span>
            </nav>
        </div>

        <div class="header">
            <ul class="header-list" role="menu">
                <li role="none">
                    <a role="menuitem" href="#" class="header-item">
                        <div class="header-icon">
                            <img class="header-icon" src="{{ url_for('static', filename='images/Icons/Settings icon.png') }}" alt="Logo">
                        </div>
                        <span>Settings</span>
                    </a>
                </li>

                <li role="none">
                    <a role="menuitem" href="https://github.com/ansh2903/ScalAble" target="_blank" class="header-item">
                        <div class="header-icon">
                            <img class="header-icon" src="{{ url_for('static', filename='images/Icons/GitHub icon.png') }}" alt="Help">
                        </div>
                        <span>GitHub</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content Layout -->
        <div class="main-content chat-container">
            <!-- Messages Container -->
            <div id="messageContainer" class="chat-content">
                <!-- Empty state -->
                <div class="chat-empty">
                    <img class="empty-icon" src="{{ url_for('static', filename='images/Extras/chat-empty.png') }}" alt="Empty Chat Icon">
                </div>

                <!-- Messages container -->
                <div class="chat-messages">
                    <!-- Example message -->    
                </div>
            </div>

            <!-- Chat Input Bar -->
            <div class="chat-input-container">
                <!-- Input Form -->
                <form id="chatForm" method="POST" autocomplete="off">
                    <div class="chat-input-bar">

                        <!-- Database Select -->
                        <div class="chat-input db-select-container">
                            <select class="db-select" name="selected_db_id" id="selected_db_id" required>
                                <option value="" disabled {% if not selected_db_id %}selected{% endif %}>
                                    Select Database
                                </option>

                                {% for conn in connections %}
                                <option value="{{ conn.id }}"
                                    {% if selected_db_id and conn.id == selected_db_id|int %}selected{% endif %}
                                        data-db-type="{{ conn.db_type }}"
                                        data-name="{{ conn.name }}">
                                    {{ conn.db_type.capitalize() }} - {{ conn.name }}
                                </option>
                                {% endfor %}

                                <option value="configure_db" data-link="{{ url_for('interface.connections') }}">
                                    Configure Database
                                </option>

                                {% if not connections %}
                                <option value="" disabled>No databases configured</option>
                                {% endif %}
                            </select>
                            <img class="btn-icon" src="{{ url_for('static', filename='images/Icons/arrow up icon.png') }}" alt="arrow-up">
                        </div>

                        <!-- File Input -->
                        <div class="chat-input file-input">
                            <!-- Future: Add file button -->
                        </div>

                        <!-- Text Input -->
                        <div class="chat-input text-input-container">
                            <input type="text" 
                                id="messageInput" 
                                name="message" 
                                class="text-input form-control"
                                placeholder="Ask a question about your data..." 
                                {% if not connections %}disabled{% endif %}
                                required />

                            <!-- Send Button -->
                            <button class="send-button" id="sendMessageBtn" type="submit">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/send icon.png') }}" alt="send">    
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>

    <script>
        function toggleChatState() {
            const chatEmpty = document.querySelector('.chat-empty');
            const chatMessages = document.querySelector('.chat-messages');

            if (chatMessages.children.length === 0) {
                chatEmpty.style.display = 'block';
                chatMessages.style.display = 'none';
            } else {
                chatEmpty.style.display = 'none';
                chatMessages.style.display = 'flex';
                chatMessages.style.flexDirection = 'column';
            }
        }

        // Call it once on load
        toggleChatState();

        // Call it again whenever a new message is added
        function addMessage(text, sender = 'user', id = null) {
            const msg = document.createElement('div');
            msg.classList.add('message', sender);
            if (id) msg.id = id; // assign id if provided
            msg.textContent = text;
            document.querySelector('.chat-messages').appendChild(msg);
            toggleChatState();
        }

        function scrollToBottom() {
            const chatContent = document.querySelector('.chat-content');
            if (!chatContent) return;

            // Wait one animation frame (ensures DOM updates/layout)
            requestAnimationFrame(() => {
                // extra tiny delay for images/fonts (optional)
                setTimeout(() => {
                    chatContent.scrollTop = chatContent.scrollHeight;
                }, 20);
            });
        }


        document.addEventListener("DOMContentLoaded", function () {
            const dbSelect = document.getElementById("selected_db_id");

            dbSelect.addEventListener("change", function () {
                const selectedOption = dbSelect.options[dbSelect.selectedIndex];
                const value = selectedOption.value;

                if (value === "configure_db") {
                    const link = selectedOption.getAttribute("data-link");
                    if (link) {
                        window.location.href = link;
                    }
                }
            });
        });

        document.getElementById("chatForm").addEventListener("submit", function(e) {
            e.preventDefault();

            const dbId = document.getElementById("selected_db_id").value;
            const inputEl = document.getElementById("messageInput");
            const message = inputEl.value.trim();

            if (!dbId || !message) return;

            // Clear input immediately
            inputEl.value = "";

            // Create a temporary user message bubble instantly
            const tempId = "temp-" + Date.now();
            addMessage(message, 'user', tempId);
            
            // Show typing indicator instead of the old loading spinner
            showTypingIndicator();

            fetch("{{ url_for('interface.chat') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: new URLSearchParams({
                    message: message,
                    selected_db_id: dbId
                })
            })
            .then(res => res.json())
            .then(data => {
                // Remove temp bubble
                const tempBubble = document.getElementById(tempId);
                if (tempBubble) tempBubble.remove();

                // Replace typing indicator with Flask-rendered response
                replaceTypingWithResponse(data.chat_html);
            })
            .catch(err => {
                // Remove typing indicator and show error
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                addMessage("Sorry, there was an error processing your request.", 'bot');
                console.error("Error:", err);
            });
        });


        function insertTableHtmlForUid(uid, html) {
            const container = document.getElementById(`tableContainer_${uid}`);
            if (container) {
                container.innerHTML = html;
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                return true;
            }
            return false;
            }

            document.addEventListener("click", function(e) {
            const runBtnEl = e.target.closest("button.run-query-btn");
            if (runBtnEl) {
                e.preventDefault();

                const form = runBtnEl.closest("form");
                if (!form) return alert("Form not found");

                let uid = runBtnEl.dataset.uid || "";
                if (!uid) {
                const uidInput = form.querySelector('input[name="unique_id"]');
                if (uidInput) uid = uidInput.value;
                }

                updateQueryBeforeSubmit(uid);

                const queryInput = form.querySelector('input[name="query"]');
                const dbTypeInput = form.querySelector('input[name="db_type"]');
                const credentialsInput = form.querySelector('input[name="credentials"]');
                
                if (!queryInput || !dbTypeInput || !credentialsInput) {
                return alert("Required form fields not found");
                }

                const formData = new FormData();
                formData.append('query', queryInput.value);
                formData.append('db_type', dbTypeInput.value);
                formData.append('credentials', credentialsInput.value);
                formData.append('unique_id', uid);

                setButtonLoading(runBtnEl, true);

                fetch("{{ url_for('interface.chat') }}", {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: formData
                })
                .then(async (res) => {
                setButtonLoading(runBtnEl, false);
                if (!res.ok) {
                    let errText = res.statusText;
                    try {
                    const errObj = await res.json();
                    errText = errObj.error || errObj.chat_html || JSON.stringify(errObj);
                    } catch(_) {}
                    throw new Error(errText);
                }
                return res.json();
                })
                .then(data => {
                console.log('Server response:', data); // Debug log
                
                const returnedUid = data.unique_id || uid;
                const tableHtml = data.table_html || data.chat_html || "";

                if (returnedUid && tableHtml) {
                    const container = document.getElementById(`tableContainer_${returnedUid}`);
                    if (container) {
                    container.innerHTML = tableHtml;
                    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                    console.warn(`Container tableContainer_${returnedUid} not found`);
                    const chatMessages = document.querySelector('.chat-messages');
                    if (chatMessages) {
                        chatMessages.insertAdjacentHTML('beforeend', tableHtml);
                        toggleChatState();
                        scrollToBottom();
                    }
                    }
                } else {
                    console.error('Missing unique_id or table_html in response:', data);
                }
                })
                .catch(err => {
                setButtonLoading(runBtnEl, false);
                console.error("Error running query:", err);
                
                if (uid) {
                    const container = document.getElementById(`tableContainer_${uid}`);
                    if (container) {
                    container.innerHTML = `<div class="error">Error running query: ${err.message}</div>`;
                    }
                }
                
                alert("Error running query: " + err.message);
                });

                return;
            }
            });

            document.addEventListener("click", function(e) {
                if (e.target && e.target.matches(".analyse-btn")) {
                    const url = e.target.getAttribute("data-url");
                    window.location.href = url; // navigate directly
                }
            });

            function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.textContent = 'Running...';
                button.style.opacity = '0.6';
            } else {
                button.disabled = false;
                button.textContent = 'Execute';
                button.style.opacity = '1';
            }
            }
        // Store editing states for multiple query blocks
        const editingStates = {};

        function toggleEdit(queryId) {
            const queryText = document.getElementById(`queryText_${queryId}`);
            const editBtn = document.querySelector(`[data-query-id="${queryId}"] .edit-btn`);
            const editControls = document.getElementById(`editControls_${queryId}`);
            
            if (!editingStates[queryId] || !editingStates[queryId].isEditing) {
                // Start editing
                editingStates[queryId] = {
                    isEditing: true,
                    originalQuery: queryText.textContent.trim()
                };
                
                queryText.contentEditable = 'true';
                queryText.classList.add('editing');
                queryText.focus();
                
                // Hide the edit button while editing
                editBtn.style.display = 'none';
                
                // Show save + cancel controls
                editControls.style.display = 'block';
                
                // Place cursor at end
                const range = document.createRange();
                const selection = window.getSelection();
                range.selectNodeContents(queryText);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
                
                addEventListeners(queryId);
            }
        }

        function saveEdit(queryId) {
            const queryText = document.getElementById(`queryText_${queryId}`);
            const hiddenQuery = document.getElementById(`hiddenQuery_${queryId}`);
            const editBtn = document.querySelector(`[data-query-id="${queryId}"] .edit-btn`);
            const editControls = document.getElementById(`editControls_${queryId}`);
            
            const newQuery = queryText.textContent.trim();
            hiddenQuery.value = newQuery;
            
            queryText.contentEditable = 'false';
            queryText.classList.remove('editing');
            
            // Restore edit button
            editBtn.style.display = 'inline-block';
            
            editControls.style.display = 'none';
            
            editingStates[queryId] = {
                isEditing: false,
                originalQuery: newQuery
            };
            
            showFeedback('Query updated successfully!', 'success');
        }

        function cancelEdit(queryId) {
            const queryText = document.getElementById(`queryText_${queryId}`);
            const editBtn = document.querySelector(`[data-query-id="${queryId}"] .edit-btn`);
            const editControls = document.getElementById(`editControls_${queryId}`);
            
            if (editingStates[queryId]) {
                queryText.textContent = editingStates[queryId].originalQuery;
                queryText.contentEditable = 'false';
                queryText.classList.remove('editing');
                
                // Restore edit button
                editBtn.style.display = 'inline-block';
                
                editControls.style.display = 'none';
                
                editingStates[queryId].isEditing = false;
            }
        }

        function updateQueryBeforeSubmit(queryId) {
            // Ensure the hidden input is updated before form submission
            if (editingStates[queryId] && editingStates[queryId].isEditing) {
                const queryText = document.getElementById(`queryText_${queryId}`);
                const hiddenQuery = document.getElementById(`hiddenQuery_${queryId}`);
                hiddenQuery.value = queryText.textContent.trim();
            }
        }

        function addEventListeners(queryId) {
            const queryText = document.getElementById(`queryText_${queryId}`);
            
            // Remove existing listeners to avoid duplicates
            queryText.removeEventListener('keydown', handleKeydown);
            queryText.removeEventListener('input', handleInput);
            
            // Add new listeners
            queryText.addEventListener('keydown', function(e) {
                handleKeydown(e, queryId);
            });
            
            queryText.addEventListener('input', function() {
                handleInput(queryId);
            });
        }

        function handleKeydown(e, queryId) {
            if (editingStates[queryId] && editingStates[queryId].isEditing) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    saveEdit(queryId);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit(queryId);
                }
            }
        }

        function handleInput(queryId) {
            if (editingStates[queryId] && editingStates[queryId].isEditing) {
                const queryText = document.getElementById(`queryText_${queryId}`);
                const hiddenQuery = document.getElementById(`hiddenQuery_${queryId}`);
                hiddenQuery.value = queryText.textContent.trim();
            }
        }

        function showFeedback(message, type) {
            // Create a temporary feedback element
            const feedback = document.createElement('div');
            feedback.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            feedback.style.top = '20px';
            feedback.style.right = '20px';
            feedback.style.zIndex = '9999';
            feedback.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(feedback);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (feedback.parentElement) {
                    feedback.remove();
                }
            }, 3000);
        }

        function showTypingIndicator() {
            const chatMessages = document.querySelector('.chat-messages');
            if (!chatMessages) return;

            // Remove existing typing indicator
            const existing = document.getElementById('typing-indicator');
            if (existing) existing.remove();

            // Create typing indicator bubble
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'message bot typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);

            toggleChatState(); // show/hide empty state
            scrollToBottom();
        }

        function replaceTypingWithResponse(htmlContent) {
            const typingIndicator = document.getElementById('typing-indicator');
            const msgContainer = document.querySelector(".chat-messages");

            // Remove typing indicator if present
            if (typingIndicator) typingIndicator.remove();

            // Insert the server-rendered HTML
            msgContainer.insertAdjacentHTML("beforeend", htmlContent);

            toggleChatState();
            // small delay to let browser render the new content then scroll
            setTimeout(() => { scrollToBottom(); }, 30);
        }
    </script>
</body>
</html>
