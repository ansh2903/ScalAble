<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="theme">
    <div class="dashboard">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        <path d="M12 22V12" stroke="currentColor" stroke-width="2"/>
                        <path d="M22 7L12 12L2 7" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </div>
                
            <nav class="sidebar-nav" role="navigation" aria-label="Main navigation">
                <ul class="nav-list" role="menu">
                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item active" aria-current="page">
                            <div class="nav-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="3" width="7" height="7" stroke="currentColor" stroke-width="2" rx="1"/>
                                    <rect x="14" y="3" width="7" height="7" stroke="currentColor" stroke-width="2" rx="1"/>
                                    <rect x="14" y="14" width="7" height="7" stroke="currentColor" stroke-width="2" rx="1"/>
                                    <rect x="3" y="14" width="7" height="7" stroke="currentColor" stroke-width="2" rx="1"/>
                                </svg>
                            </div>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/Chat icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="/connections" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/Database icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="/settings" class="nav-item">
                            <div class="nav-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12.89 1.45L8 5.6C7.11 6.27 6.6 7.33 6.6 8.45V14.45C6.6 15.57 7.11 16.63 8 17.3L12.89 21.45C11.3 22.5 9.1 22.5 7.51 21.45L2.62 17.3C1.73 16.63 1.22 15.57 1.22 14.45V8.45C1.22 7.33 1.73 6.27 2.62 5.6L7.51 1.45C9.1 0.4 11.3 0.4 12.89 1.45Z" fill="currentColor"/>
                                    <path d="M22.78 9.55V15.55C22.78 16.67 22.27 17.73 21.38 18.4L16.49 22.55C14.9 23.6 12.7 23.6 11.11 22.55L16 18.4C16.89 17.73 17.4 16.67 17.4 15.55V9.55C17.4 8.43 16.89 7.37 16 6.7L11.11 2.55C12.7 1.5 14.9 1.5 16.49 2.55L21.38 6.7C22.27 7.37 22.78 8.43 22.78 9.55Z" fill="currentColor"/>
                                </svg>
                            </div>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="https://github.com/ansh2903/ScalAble" target="_blank" rel="noopener noreferrer" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/github icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="https://www.linkedin.com/in/asharma2903/" target="_blank" rel="noopener noreferrer" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/linkedin icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <nav class ="sidebar-footer" role="navigation" aria-label="Footer navigation">
                <ul class="nav-list" role="menu">
                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/Settings icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>

                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item">
                            <div class="nav-icon">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/Help icon.png') }}" alt="Logo">
                            </div>
                        </a>
                    </li>

                    <li role="none">
                        <a role="menuitem" href="#" class="nav-item">
                            <div class="nav-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="currentColor"/>
                                    <path d="M11,15H13V17H11V15Z" fill="currentColor"/>
                                    <path d="M11,9H13V13H11V9Z" fill="currentColor"/>
                                </svg>
                            </div>
                        </a>
                    </li>
                </ul>
                <span class="version">v0.6</span>
                <span class="copyright">&copy; 2023 ScalAble</span>
            </nav>
        </div>

        <div class="split-container">
            <div class="pane left-pane">
                <div class="btn-container">
                    <button class="analyse-data-btn tab-btn" data-target="html_data" role="tab" aria-selected="true">Data</button>
                    <button class="analyse-analyse-btn tab-btn" data-target="analysis_results" role="tab" aria-selected="false">Analyse</button>
                    <button class="analyse-export-btn tab-btn" data-target="export_section" role="tab" aria-selected="false">Export</button>
                </div>

                <div class="data-controls">
                    <div class="data-toolbar">
                        <div class="actions">
                            <!-- Custom Dropdown -->
                            <div class="custom-dropdown" id="downloadDropdown">
                                <button class="dropdown-btn">Download</button>
                                <div class="dropdown-content">
                                    <div class="dropdown-item" data-value="json">
                                        <img src="/static/icons/json.png" alt="JSON">
                                        JSON
                                    </div>
                                    <div class="dropdown-item" data-value="csv">
                                        <img src="/static/icons/csv.png" alt="CSV">
                                        CSV
                                    </div>
                                    <div class="dropdown-item" data-value="excel">
                                        <img src="/static/icons/excel.png" alt="Excel">
                                        Excel
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="html_data" class="data-container">

                    </div>

                    <div class="table-footer">
                        <button class="page-btn">&larr;</button>
                        <button class="page-btn active">1</button>
                    </div>
                </div>

                <div id="analysis_results" class="data-container">
                    <h3>Analysis Results</h3>
                    <p>This section will display the results of the data analysis.</p>
                    <div id="chart-container">
                        <canvas id="analysisChart"></canvas>
                    </div>

                    <div class="runable-python-code">
                        <h4>Generated Python Code</h4>
                        <div id="codeOutput" class="code-output"></div>
                        <pre><code id="pythonCode"># Python code will be displayed here</code></pre>
                        <button id="copyCodeBtn">Copy Code</button>
                        <button id="runCodeBtn">Run Code</button>
                    </div>
                </div>

                <div class="data-container" id="export_section" >
                    <h3>Export Data</h3>
                    <p>This section will allow you to export the data in various formats.</p>
                    <button id="exportCsvBtn">Export as CSV</button>
                    <button id="exportJsonBtn">Export as JSON</button>
                </div>
            </div>

            <div class="gutter">
                <div id="gutter" class="gutter-handle"></div>
            </div>

            <div class="pane right-pane">
<div id="uploadModalOverlay" class="upload-modal-overlay hidden" aria-hidden="true">
  <div id="uploadModal" class="upload-modal-content" role="dialog" aria-modal="true" aria-labelledby="uploadTitle">
    <button class="upload-close-btn" aria-label="Close">&times;</button>
    <h3 id="uploadTitle">Upload File</h3>

    <div class="form-group">
      <label for="upload_db_select">Choose target database</label>
      <select id="upload_db_select" class="db-select">
        <option value="" disabled selected>Select database</option>
        {% for conn in connections %}
        <option value="{{ conn.id }}" data-db-type="{{ conn.db_type }}">{{ conn.db_type.capitalize() }} - {{ conn.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="upload-columns">
      <div class="upload-col">
        <span class="upload-col-title">Provide a file path</span>
        <input type="text" id="filePathInput" placeholder="C:\path\to\file.csv or /home/user/file.xlsx">

        <span class="upload-col-title">Table name</span>
        <input type="text" id="tableNameInput" placeholder="Enter target table name">

        <button id="submitPathBtn" class="btn-primary">Submit</button>

        <!-- 🔄 Loader -->
        <div id="uploadLoader" class="hidden loader">
          <div class="spinner"></div>
          <span>Processing file, please wait...</span>
        </div>
      </div>
    </div>
  </div>
</div>

                <!-- Main Content Layout -->
                <div class="main-content chat-container">
                    <!-- Messages Container -->
                    <div id="messageContainer" class="chat-content">
                        <!-- Empty state -->
                        <div class="chat-empty">
                            <img class="empty-icon" src="{{ url_for('static', filename='images/Extras/chat-empty.png') }}" alt="Empty Chat Icon">
                        </div>

                        <!-- Messages container -->
                        <div class="chat-messages">
                            <!-- Example message -->    
                        </div>
                    </div>

                    <!-- Chat Input Bar (placed inside .right-pane so it moves with the pane) -->
                    <div class="chat-input-wrapper">
                        <form id="chatForm" method="POST" autocomplete="off" class="chat-input-form">
                            <div class="chat-input-left">
                            <button type="button" class="dropdown-btn" id="upload_file">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/file upload icon.png') }}" alt="upload">
                                <span>File Upload</span>
                            </button>
                            <div id="fileInfo" class="file-info"></div>

                            </div>

                            <!-- Hidden file input -->
                            <input type="file" id="hiddenFileInput" style="display:none;" accept=".csv,.json,.xlsx">

                            <div class="chat-input-center">
                                <textarea id="messageInput" name="message" class="text-input" rows="1"
                                    placeholder="What's on your mind?" required></textarea>
                            </div>

                            <div class="chat-input-right">
                            <select class="db-select" name="selected_db_id" id="selected_db_id" aria-label="Select database" required>
                                <option value="" disabled {% if not selected_db_id %}selected{% endif %}>Select Database</option>
                                {% for conn in connections %}
                                <option value="{{ conn.id }}"
                                    {% if selected_db_id and conn.id == selected_db_id|int %}selected{% endif %}
                                    data-db-type="{{ conn.db_type }}" data-name="{{ conn.name }}">
                                {{ conn.db_type.capitalize() }} - {{ conn.name }}
                                </option>
                                {% endfor %}
                                <option value="configure_db" data-link="{{ url_for('interface.connections') }}">Configure Database</option>
                                {% if not connections %}<option value="" disabled>No databases configured</option>{% endif %}
                            </select>

                            <!-- circular send button -->
                            <button class="send-button" id="sendMessageBtn" type="submit" aria-label="Send message">
                                <img class="nav-icon" src="{{ url_for('static', filename='images/Icons/send icon.png') }}" alt="send">                            </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>

    <script>
document.addEventListener("DOMContentLoaded", () => {
  const uploadBtn = document.getElementById("upload_file");
  const overlay = document.getElementById("uploadModalOverlay");
  const modal = document.getElementById("uploadModal");
  const closeBtn = modal.querySelector(".upload-close-btn");

  const submitPathBtn = document.getElementById("submitPathBtn");
  const filePathInput = document.getElementById("filePathInput");
  const tableNameInput = document.getElementById("tableNameInput");
  const modalDbSelect = document.getElementById("upload_db_select");

  function openModal() {
    overlay.classList.remove("hidden");
    overlay.setAttribute("aria-hidden", "false");
    setTimeout(() => modalDbSelect.focus(), 50);
  }
  function closeModal() {
    overlay.classList.add("hidden");
    overlay.setAttribute("aria-hidden", "true");
  }

  // open
  if (uploadBtn) uploadBtn.addEventListener("click", (ev) => { ev.preventDefault(); openModal(); });

  // close
  overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModal(); });
  closeBtn.addEventListener("click", () => closeModal());

  // Submit path + selected db id + table name
submitPathBtn.addEventListener("click", () => {
  const filePath = filePathInput.value.trim();
  const selectedDbId = modalDbSelect.value;
  const tableName = tableNameInput.value.trim();
  const loader = document.getElementById("uploadLoader");

  if (!filePath) { alert("Please enter a file path."); return; }
  if (!selectedDbId) { alert("Please choose a target database."); return; }
  if (!tableName) { alert("Please enter a target table name."); return; }

  const payload = {
    file_path: filePath,
    selected_db_id: String(selectedDbId),
    table_name: tableName
  };

  // show loader
  loader.classList.remove("hidden");
  submitPathBtn.disabled = true;

  fetch("/uploadfile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  })
  .then(async res => {
    let data;
    try { data = await res.json(); } catch { data = await res.text(); }

    if (!res.ok) {
      console.error("Server error:", data);
      alert("Server error: " + (data.error || JSON.stringify(data)));
      return;
    }

    filePathInput.value = "";
    tableNameInput.value = "";
    closeModal();

    if (data.inferred_sql) {
      const chatMessages = document.querySelector('.chat-messages');
      const uid = 'inferred-' + Date.now();
      const botHtml = `
        <div class="message bot" id="${uid}">
          <div class="msg-comment">I inferred a table structure for <strong>${data.table_name}</strong>:</div>
          <pre class="msg-text">${escapeHtml(data.inferred_sql)}</pre>
          ${data.llm_comment ? `<div class="msg-comment">${escapeHtml(data.llm_comment)}</div>` : ''}
        </div>
      `;
      if (chatMessages) {
        chatMessages.insertAdjacentHTML('beforeend', botHtml);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    if (data.detail) {
      console.log("Import result:", data.detail);
    }
  })
  .catch(err => {
    console.error("Network error:", err);
    alert("Network error submitting path.");
  })
  .finally(() => {
    // hide loader
    loader.classList.add("hidden");
    submitPathBtn.disabled = false;
  });
});
});

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}


        document.querySelectorAll(".custom-dropdown").forEach(dropdown => {
        const btn = dropdown.querySelector(".dropdown-btn");
        const menu = dropdown.querySelector(".dropdown-content");
        let isOpen = false;
        let placeholder = null;

        menu.style.position = menu.style.position || "absolute";
        menu.style.display = "none";
        menu.style.zIndex = 9999;
        menu.style.maxHeight = menu.style.maxHeight || "60vh";
        menu.style.overflowY = menu.style.overflowY || "auto";

        function closeMenu() {
            if (!isOpen) return;
            if (placeholder) {
            placeholder.replaceWith(menu);
            placeholder = null;
            }
            menu.style.display = "none";
            menu.style.visibility = "";
            menu.classList.remove("drop-up", "drop-down");
            isOpen = false;
            document.removeEventListener("click", onDocClick);
            document.removeEventListener("keydown", onEsc);
            window.removeEventListener("resize", reposition);
            window.removeEventListener("scroll", reposition, true);
        }

        function onDocClick(e) {
            if (!menu.contains(e.target) && !btn.contains(e.target)) closeMenu();
        }
        function onEsc(e) { if (e.key === "Escape") closeMenu(); }
        function reposition() { if (isOpen) positionMenu(); }

        function positionMenu() {
            menu.style.display = "block";
            menu.style.visibility = "hidden";
            if (menu.parentElement !== document.body) {
            placeholder = document.createElement("span");
            placeholder.className = "menu-placeholder";
            menu.replaceWith(placeholder);
            document.body.appendChild(menu);
            }

            const btnRect = btn.getBoundingClientRect();
            const menuHeight = menu.offsetHeight || 200;
            const menuWidth = Math.max(menu.offsetWidth || 180, btnRect.width);
            const padding = 8;

            const spaceBelow = window.innerHeight - btnRect.bottom;
            const spaceAbove = btnRect.top;

            let top;
            if (spaceBelow >= menuHeight + padding || spaceBelow >= spaceAbove) {
            menu.classList.remove("drop-up");
            menu.classList.add("drop-down");
            top = btnRect.bottom + padding + window.scrollY;
            } else {
            menu.classList.remove("drop-down");
            menu.classList.add("drop-up");
            top = btnRect.top - menuHeight - padding + window.scrollY;
            if (top < window.scrollY + 8) top = window.scrollY + 8;
            }

            let left = btnRect.left + window.scrollX;
            const rightClamp = window.scrollX + window.innerWidth - menuWidth - 8;
            if (left > rightClamp) left = rightClamp;
            if (left < window.scrollX + 8) left = window.scrollX + 8;

            menu.style.top = `${Math.round(top)}px`;
            menu.style.left = `${Math.round(left)}px`;
            menu.style.minWidth = `${Math.round(menuWidth)}px`;
            menu.style.visibility = "visible";
            menu.style.display = "block";
        }

        function openMenu() {
            if (isOpen) return;
            positionMenu();
            isOpen = true;
            document.addEventListener("click", onDocClick);
            document.addEventListener("keydown", onEsc);
            window.addEventListener("resize", reposition);
            window.addEventListener("scroll", reposition, true);
        }

        btn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            if (isOpen) closeMenu();
            else openMenu();
        });

        // item clicks → behave based on dropdown id
        menu.querySelectorAll(".dropdown-item").forEach(item => {
            item.addEventListener("click", (ev) => {
            ev.stopPropagation();
            const value = item.getAttribute("data-value");
            closeMenu();

            const dropdownId = dropdown.id;
            if (dropdownId === "downloadDropdown") {
                window.location.href = `/download/${value}`;
            }
            else {
                console.log(`Clicked ${value} in ${dropdownId}`);
            }
            });
        });
        });

        document.addEventListener('DOMContentLoaded', () => {
        const ta = document.getElementById('messageInput');
        if (!ta) return;

        const MAX_HEIGHT = 220; // match CSS max-height (px)

        // Resize utility
        function autoResize(el) {
            el.style.height = 'auto';               // reset height
            const needed = el.scrollHeight;         // required height
            const newHeight = Math.min(needed, MAX_HEIGHT);
            el.style.height = newHeight + 'px';

            if (needed > MAX_HEIGHT) {
            el.classList.add('scrolled');         // allow overflow-y auto
            el.style.overflowY = 'auto';
            } else {
            el.classList.remove('scrolled');
            el.style.overflowY = 'hidden';
            }
        }

        // init size (useful if textarea has pre-filled value)
        autoResize(ta);

        // events
        ta.addEventListener('input', () => autoResize(ta));
        ta.addEventListener('paste', () => {
            // run after paste has inserted text
            requestAnimationFrame(() => autoResize(ta));
        });

        // Optional: submit on Ctrl+Enter while preserving Enter for new lines
        ta.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            // submit the form
            const form = ta.closest('form');
            if (form) form.requestSubmit(); // modern, or form.submit() if needed
            }
        });

        });

        document.addEventListener("DOMContentLoaded", () => {
        const container = document.querySelector('.split-container');
        const leftPane = document.querySelector('.left-pane');
        const rightPane = document.querySelector('.right-pane');
        const gutter = document.getElementById('gutter');
        let isResizing = false;

        // --- Open / Close ---
        function openLeftPane(percentage = 40) {
            container.classList.add('left-open');

            percentage = Math.max(10, Math.min(90, percentage));
            leftPane.style.width = percentage + '%';
            rightPane.style.width = (100 - percentage) + '%';

            gutter.parentElement.style.display = 'block';
        }

        function closeLeftPane() {
            container.classList.remove('left-open');
            leftPane.style.width = '0';
            rightPane.style.width = '100%';
            gutter.parentElement.style.display = 'none';
        }

        // collapse initially
        closeLeftPane();

        // --- Drag Resize ---
        gutter.addEventListener('mousedown', (e) => {
            isResizing = true;
            container.classList.add('dragging');
            gutter.classList.add('dragging');
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const rect = container.getBoundingClientRect();
            const gutterWidth = gutter.offsetWidth;

            let newLeftWidth = e.clientX - rect.left;
            const minWidth = 200;
            const maxLeftWidth = rect.width - minWidth - gutterWidth;
            newLeftWidth = Math.max(minWidth, Math.min(newLeftWidth, maxLeftWidth));

            const percentage = (newLeftWidth / rect.width) * 100;
            leftPane.style.width = percentage + '%';
            rightPane.style.width = (100 - percentage) + '%';
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
            isResizing = false;
            container.classList.remove('dragging');
            gutter.classList.remove('dragging');
            }
        });

        // --- Touch support ---
        gutter.addEventListener('touchstart', (e) => {
            isResizing = true;
            container.classList.add('dragging');
            gutter.classList.add('dragging');
            e.preventDefault();
        });

        document.addEventListener('touchmove', (e) => {
            if (!isResizing) return;
            const touch = e.touches[0];
            const rect = container.getBoundingClientRect();
            const gutterWidth = gutter.offsetWidth;

            let newLeftWidth = touch.clientX - rect.left;
            const minWidth = 200;
            const maxLeftWidth = rect.width - minWidth - gutterWidth;
            newLeftWidth = Math.max(minWidth, Math.min(newLeftWidth, maxLeftWidth));

            const percentage = (newLeftWidth / rect.width) * 100;
            leftPane.style.width = percentage + '%';
            rightPane.style.width = (100 - percentage) + '%';
            e.preventDefault();
        });

        document.addEventListener('touchend', () => {
            if (isResizing) {
            isResizing = false;
            container.classList.remove('dragging');
            gutter.classList.remove('dragging');
            }
        });

        // Expose functions globally if needed
        window.openLeftPane = openLeftPane;
        window.closeLeftPane = closeLeftPane;
        });


        function toggleChatState() {
            const chatEmpty = document.querySelector('.chat-empty');
            const chatMessages = document.querySelector('.chat-messages');

            if (chatMessages.children.length === 0) {
                chatEmpty.style.display = 'block';
                chatMessages.style.display = 'none';
            } else {
                chatEmpty.style.display = 'none';
                chatMessages.style.display = 'flex';
                chatMessages.style.flexDirection = 'column';
            }
        }

        // Call it once on load
        toggleChatState();

        // Call it again whenever a new message is added
        function addMessage(text, sender = 'user', id = null) {
            const msg = document.createElement('div');
            msg.classList.add('message', sender);
            if (id) msg.id = id; // assign id if provided
            msg.textContent = text;
            document.querySelector('.chat-messages').appendChild(msg);
            toggleChatState();
        }

        function scrollToBottom() {
            const chatContent = document.querySelector('.chat-content');
            if (!chatContent) return;

            // Wait one animation frame (ensures DOM updates/layout)
            requestAnimationFrame(() => {
                // extra tiny delay for images/fonts (optional)
                setTimeout(() => {
                    chatContent.scrollTop = chatContent.scrollHeight;
                }, 20);
            });
        }


        document.addEventListener("DOMContentLoaded", function () {
            const dbSelect = document.getElementById("selected_db_id");

            dbSelect.addEventListener("change", function () {
                const selectedOption = dbSelect.options[dbSelect.selectedIndex];
                const value = selectedOption.value;

                if (value === "configure_db") {
                    const link = selectedOption.getAttribute("data-link");
                    if (link) {
                        window.location.href = link;
                    }
                }
            });
        });

        document.getElementById("chatForm").addEventListener("submit", function(e) {
            e.preventDefault();

            const dbId = document.getElementById("selected_db_id").value;
            const inputEl = document.getElementById("messageInput");
            const message = inputEl.value.trim();

            if (!dbId || !message) return;

            // Clear input immediately
            inputEl.value = "";

            // Create a temporary user message bubble instantly
            const tempId = "temp-" + Date.now();
            addMessage(message, 'user', tempId);
            
            // Show typing indicator instead of the old loading spinner
            showTypingIndicator();

            fetch("{{ url_for('interface.chat') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: new URLSearchParams({
                    message: message,
                    selected_db_id: dbId
                })
            })
            .then(res => res.json())
            .then(data => {
                // Remove temp bubble
                const tempBubble = document.getElementById(tempId);
                if (tempBubble) tempBubble.remove();

                // Replace typing indicator with Flask-rendered response
                replaceTypingWithResponse(data.chat_html);
            })
            .catch(err => {
                // Remove typing indicator and show error
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                addMessage("Sorry, there was an error processing your request.", 'bot');
                console.error("Error:", err);
            });
        });


        function insertTableHtmlForUid(uid, html) {
            const container = document.getElementById(`tableContainer_${uid}`);
            if (container) {
                container.innerHTML = html;
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                return true;
            }
            return false;
            }

            document.addEventListener("click", function(e) {
            const runBtnEl = e.target.closest("button.run-query-btn");
            if (runBtnEl) {
                e.preventDefault();

                const form = runBtnEl.closest("form");
                if (!form) return alert("Form not found");

                let uid = runBtnEl.dataset.uid || "";
                if (!uid) {
                const uidInput = form.querySelector('input[name="unique_id"]');
                if (uidInput) uid = uidInput.value;
                }

                updateQueryBeforeSubmit(uid);

                const queryInput = form.querySelector('input[name="query"]');
                const dbTypeInput = form.querySelector('input[name="db_type"]');
                const credentialsInput = form.querySelector('input[name="credentials"]');
                
                if (!queryInput || !dbTypeInput || !credentialsInput) {
                return alert("Required form fields not found");
                }

                const formData = new FormData();
                formData.append('query', queryInput.value);
                formData.append('db_type', dbTypeInput.value);
                formData.append('credentials', credentialsInput.value);
                formData.append('unique_id', uid);
                const selectedDbInput = form.querySelector('input[name="selected_db_id"]');
                if (selectedDbInput) {
                    formData.append('selected_db_id', selectedDbInput.value);
                }

                setButtonLoading(runBtnEl, true);

                fetch("{{ url_for('interface.chat') }}", {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: formData
                })
                .then(async (res) => {
                setButtonLoading(runBtnEl, false);
                if (!res.ok) {
                    let errText = res.statusText;
                    try {
                    const errObj = await res.json();
                    errText = errObj.error || errObj.chat_html || JSON.stringify(errObj);
                    } catch(_) {}
                    throw new Error(errText);
                }
                return res.json();
                })
                .then(data => {
                console.log('Server response:', data); // Debug log
                
                const returnedUid = data.unique_id || uid;
                const tableHtml = data.table_html || data.chat_html || "";

                if (returnedUid && tableHtml) {
                    const container = document.getElementById(`tableContainer_${returnedUid}`);
                    if (container) {
                    container.innerHTML = tableHtml;
                    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                    console.warn(`Container tableContainer_${returnedUid} not found`);
                    const chatMessages = document.querySelector('.chat-messages');
                    if (chatMessages) {
                        chatMessages.insertAdjacentHTML('beforeend', tableHtml);
                        toggleChatState();
                        scrollToBottom();
                    }
                    }
                } else {
                    console.error('Missing unique_id or table_html in response:', data);
                }
                })
                .catch(err => {
                setButtonLoading(runBtnEl, false);
                console.error("Error running query:", err);
                
                if (uid) {
                    const container = document.getElementById(`tableContainer_${uid}`);
                    if (container) {
                    container.innerHTML = `<div class="error">Error running query: ${err.message}</div>`;
                    }
                }
                
                alert("Error running query: " + err.message);
                });

                return;
            }
            });

        document.addEventListener("click", function (e) {
        const analyseBtn = e.target.closest(".analyse-btn");
        if (!analyseBtn) return;

        e.preventDefault();

        // open left pane
        openLeftPane(60);

        // get unique id (button has data-uid)
        const uid = analyseBtn.dataset.uid || analyseBtn.getAttribute("data-uid") || "";

        // Build FormData for the POST. The backend checks for "table" in request.form.
        const formData = new FormData();
        formData.append("table", "1");          // presence of this key triggers backend branch
        if (uid) formData.append("unique_id", uid);

        // Send to same endpoint your chat form uses
        fetch(window.location.pathname, {
            method: "POST",
            headers: {
            "X-Requested-With": "XMLHttpRequest" // helps backend detect AJAX
            },
            body: formData
        })
        .then(async (res) => {
            if (!res.ok) {
            const errText = await res.text().catch(()=>res.statusText);
            throw new Error(errText || 'Request failed');
            }
            return res.json();
        })
        .then(result => {
            // Expecting result to have either 'html_data' or 'data'
            const container = document.querySelector(".left-pane #html_data");
            if (!container) {
            console.warn("Left pane html_data container not found");
            return;
            }

        if (result.html_data) {
            container.innerHTML = result.html_data;

            // switch tab to Data panel if the helper exists
            if (typeof setAnalysisTab === 'function') {
            setAnalysisTab('html_data');
            } else if (typeof setActiveTab === 'function') {
            setActiveTab('html_data'); // fallback name
            }

            // focus first meaningful element
            const first = container.querySelector('table, button, a, input, textarea, select');
            if (first) first.focus();
            return;
        }

            if (result.data) {
            // If backend returned raw data rows, build a table
            return;
            }

            // Fallback
            container.innerHTML = "<div class='info'>No data returned from server.</div>";
        })
        .catch(err => {
            console.error("Failed to fetch analysis data:", err);
            const container = document.querySelector(".left-pane #html_data");
            if (container) container.innerHTML = `<div class="error">Error loading data: ${err.message}</div>`;
        });
        });


        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.textContent = 'Running...';
                button.style.opacity = '0.6';
            } else {
                button.disabled = false;
                button.textContent = 'Execute';
                button.style.opacity = '1';
            }
        }
        // Store editing states for multiple query blocks
        const editingStates = {};

        function toggleEdit(queryId) {
            const queryText = document.getElementById(`queryText_${queryId}`);
            const editBtn = document.querySelector(`[data-query-id="${queryId}"] .edit-btn`);
            const editControls = document.getElementById(`editControls_${queryId}`);
            
            if (!editingStates[queryId] || !editingStates[queryId].isEditing) {
                // Start editing
                editingStates[queryId] = {
                    isEditing: true,
                    originalQuery: queryText.textContent.trim()
                };
                
                queryText.contentEditable = 'true';
                queryText.classList.add('editing');
                queryText.focus();
                
                // Hide the edit button while editing
                editBtn.style.display = 'none';
                
                // Show save + cancel controls
                editControls.style.display = 'block';
                
                // Place cursor at end
                const range = document.createRange();
                const selection = window.getSelection();
                range.selectNodeContents(queryText);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
                
                addEventListeners(queryId);
            }
        }

        function saveEdit(queryId) {
            const queryText = document.getElementById(`queryText_${queryId}`);
            const hiddenQuery = document.getElementById(`hiddenQuery_${queryId}`);
            const editBtn = document.querySelector(`[data-query-id="${queryId}"] .edit-btn`);
            const editControls = document.getElementById(`editControls_${queryId}`);
            
            const newQuery = queryText.textContent.trim();
            hiddenQuery.value = newQuery;
            
            queryText.contentEditable = 'false';
            queryText.classList.remove('editing');
            
            // Restore edit button
            editBtn.style.display = 'inline-block';
            
            editControls.style.display = 'none';
            
            editingStates[queryId] = {
                isEditing: false,
                originalQuery: newQuery
            };
            
            showFeedback('Query updated successfully!', 'success');
        }

        function cancelEdit(queryId) {
            const queryText = document.getElementById(`queryText_${queryId}`);
            const editBtn = document.querySelector(`[data-query-id="${queryId}"] .edit-btn`);
            const editControls = document.getElementById(`editControls_${queryId}`);
            
            if (editingStates[queryId]) {
                queryText.textContent = editingStates[queryId].originalQuery;
                queryText.contentEditable = 'false';
                queryText.classList.remove('editing');
                
                // Restore edit button
                editBtn.style.display = 'inline-block';
                
                editControls.style.display = 'none';
                
                editingStates[queryId].isEditing = false;
            }
        }

        function updateQueryBeforeSubmit(queryId) {
            // Ensure the hidden input is updated before form submission
            if (editingStates[queryId] && editingStates[queryId].isEditing) {
                const queryText = document.getElementById(`queryText_${queryId}`);
                const hiddenQuery = document.getElementById(`hiddenQuery_${queryId}`);
                hiddenQuery.value = queryText.textContent.trim();
            }
        }

        function addEventListeners(queryId) {
            const queryText = document.getElementById(`queryText_${queryId}`);
            
            // Remove existing listeners to avoid duplicates
            queryText.removeEventListener('keydown', handleKeydown);
            queryText.removeEventListener('input', handleInput);
            
            // Add new listeners
            queryText.addEventListener('keydown', function(e) {
                handleKeydown(e, queryId);
            });
            
            queryText.addEventListener('input', function() {
                handleInput(queryId);
            });
        }

        function handleKeydown(e, queryId) {
            if (editingStates[queryId] && editingStates[queryId].isEditing) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    saveEdit(queryId);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit(queryId);
                }
            }
        }

        function handleInput(queryId) {
            if (editingStates[queryId] && editingStates[queryId].isEditing) {
                const queryText = document.getElementById(`queryText_${queryId}`);
                const hiddenQuery = document.getElementById(`hiddenQuery_${queryId}`);
                hiddenQuery.value = queryText.textContent.trim();
            }
        }

        function showFeedback(message, type) {
            // Create a temporary feedback element
            const feedback = document.createElement('div');
            feedback.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            feedback.style.top = '20px';
            feedback.style.right = '20px';
            feedback.style.zIndex = '9999';
            feedback.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(feedback);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (feedback.parentElement) {
                    feedback.remove();
                }
            }, 3000);
        }

        function showTypingIndicator() {
            const chatMessages = document.querySelector('.chat-messages');
            if (!chatMessages) return;

            // Remove existing typing indicator
            const existing = document.getElementById('typing-indicator');
            if (existing) existing.remove();

            // Create typing indicator bubble
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'message bot typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);

            toggleChatState(); // show/hide empty state
            scrollToBottom();
        }

        function replaceTypingWithResponse(htmlContent) {
            const typingIndicator = document.getElementById('typing-indicator');
            const msgContainer = document.querySelector(".chat-messages");

            // Remove typing indicator if present
            if (typingIndicator) typingIndicator.remove();

            // Insert the server-rendered HTML
            msgContainer.insertAdjacentHTML("beforeend", htmlContent);

            toggleChatState();
            // small delay to let browser render the new content then scroll
            setTimeout(() => { scrollToBottom(); }, 30);
        }

        (function () {
  // mapping fallback if data-target is not present
  const fallbackMap = {
    'analyse-data-btn': 'html_data',
    'analyse-analyse-btn': 'analysis_results',
    'analyse-export-btn': 'export_section'
  };

  // set active tab and manage aria
  function setActiveTab(targetId) {
    // hide/show panels
    document.querySelectorAll('.data-container').forEach(el => {
      if (el.id === targetId) {
        el.classList.add('active');
        el.setAttribute('aria-hidden', 'false');
      } else {
        el.classList.remove('active');
        el.setAttribute('aria-hidden', 'true');
      }
    });

    // update tab buttons
    document.querySelectorAll('.analyse-data-btn, .analyse-analyse-btn, .analyse-export-btn, .tab-btn').forEach(btn => {
      const target = btn.dataset.target || fallbackMap[btn.classList[0]] || null;
      if (!target) {
        // also try to read class names for fallback
        const cls = Array.from(btn.classList).find(c => fallbackMap[c]);
        if (cls) btn.dataset.target = fallbackMap[cls];
      }
      if ((btn.dataset.target || null) === targetId) {
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
      } else {
        btn.classList.remove('active');
        btn.setAttribute('aria-selected', 'false');
      }
    });
  }

  // call on load: default Data tab (but left pane may be closed)
  document.addEventListener('DOMContentLoaded', function () {
    setActiveTab('html_data');
  });

  // tab button clicks (works for both .tab-btn or your specific class buttons)
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.tab-btn, .analyse-data-btn, .analyse-analyse-btn, .analyse-export-btn');
    if (!btn) return;

    e.preventDefault();

    // determine target
    const target = btn.dataset.target || (() => {
      // fallback by class name
      const cls = Array.from(btn.classList).find(c => fallbackMap[c]);
      return cls ? fallbackMap[cls] : null;
    })();

    if (target) {
      setActiveTab(target);
      // if left pane is closed, open it (optional)
      if (typeof openLeftPane === 'function') {
        openLeftPane(60);
      }
      // focus first interactive element inside newly active panel
      const container = document.getElementById(target);
      if (container) {
        const focusable = container.querySelector('button, a, input, textarea, select, table');
        if (focusable) focusable.focus();
      }
    }
  });

  // Enhance your existing analyse-btn fetch handler to auto-switch to Data tab after inject.
  // If you already have an analyse-btn click handler that injects html_data, ensure it calls:
  //    setActiveTab('html_data');
  // Below is a safe wrapper that hooks into your analyze flow: it watches for AJAX injection into #html_data
  // and activates the Data tab automatically when html_data is changed.
  function observeHtmlDataInjection() {
    const target = document.querySelector('.left-pane #html_data');
    if (!target) return;
    // If content already exists, ensure tab active if left pane is open
    if (target.innerHTML.trim() !== '') {
      setActiveTab('html_data');
    }
    // Observe future changes
    const mo = new MutationObserver((mutations) => {
      // any injection -> make data tab active
      setActiveTab('html_data');
    });
    mo.observe(target, { childList: true, subtree: true });
  }

  // Start observer after DOM ready
  document.addEventListener('DOMContentLoaded', observeHtmlDataInjection);

  // Expose utility globally if needed
  window.setAnalysisTab = setActiveTab;
})();

    </script>
</body>
</html>
